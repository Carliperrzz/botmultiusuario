<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Pontis ‚Ä¢ UI m√≥vil (MVP)</title>

<!-- iOS/PWA basics -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e0f12" />
<link rel="icon" href="icon-192.png" sizes="192x192" type="image/png">
<link rel="apple-touch-icon" href="icon-180.png" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Pontis">

<style>
  :root{
    --bg:#0e0f12;--panel:#12151b;--panel-2:#171b22;--muted:#8b97a7;--text:#e8edf5;--accent:#3ddc97;--accent-2:#4ea8de;--danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}

  /* App frame */
  .app{height:100vh;max-width:460px;margin:0 auto;background:var(--panel);display:flex;flex-direction:column;border-left:1px solid #23262d;border-right:1px solid #23262d}
  .topbar{height:52px;display:flex;align-items:center;gap:10px;padding:0 12px;background:linear-gradient(180deg,#18202a,#141922);border-bottom:1px solid #23262d}
  .title{font-weight:800}
  .spacer{flex:1}
  .iconbtn{width:34px;height:34px;border-radius:10px;background:#1a212c;border:1px solid #2a3140;display:grid;place-items:center;color:#c8d2de}

  /* Screens */
  .screen{flex:1;display:none}
  .screen.active{display:flex;flex-direction:column}

  /* Segmented control */
  .seg{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;background:#0f1218;padding:6px;border-bottom:1px solid #23262d}
  .seg button{padding:8px 10px;border-radius:10px;background:#1a212c;border:1px solid #2a3140;color:#c8d2de}
  .seg button.active{background:#232a36;color:#fff;border-color:#3a4556}

  /* Lists */
  .list{overflow:auto;-webkit-overflow-scrolling:touch}
  .hint{padding:10px 12px;font-size:13px;color:var(--muted);border-bottom:1px solid #23262d;background:#121720}
  .row{display:flex;gap:10px;padding:12px;border-bottom:1px solid #23262d}
  .row:active{background:#161c25}
  .avatar{width:42px;height:42px;border-radius:12px;background:#2a3140;display:grid;place-items:center;font-weight:800}
  .meta{display:flex;justify-content:space-between;width:100%}
  .name{font-weight:700}
  .preview{font-size:13px;color:var(--muted)}
  .time{font-size:12px;color:var(--muted)}

  /* Chat */
  .chathead{height:52px;display:flex;align-items:center;gap:10px;padding:0 12px;background:linear-gradient(180deg,#18202a,#141922);border-bottom:1px solid #23262d}
  .back{width:32px;height:32px;border-radius:10px;background:#1a212c;border:1px solid #2a3140;display:grid;place-items:center}
  .who{display:flex;flex-direction:column}
  .modechip{margin-left:auto;background:#232a36;border:1px solid #2a3140;border-radius:999px;padding:2px 8px;font-size:12px}
  .no-recv{margin-left:8px;background:#3a2430;border:1px solid #5a3448;border-radius:999px;padding:2px 8px;font-size:12px}

  .chatbody{flex:1;overflow:auto;padding:14px;background:radial-gradient(1000px 600px at 100% -40%,rgba(61,220,151,.06),transparent 60%),radial-gradient(800px 400px at -20% 120%,rgba(78,168,222,.06),transparent 55%)}
  .bubble{max-width:78%;padding:10px 12px;border-radius:16px;margin:6px 0}
  .me{margin-left:auto;background:#193126;border:1px solid #254c3d}
  .them{margin-right:auto;background:#1f2430;border:1px solid #2a3140}
  .btime{display:block;font-size:11px;color:#9aa6b5;margin-top:4px}

  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #23262d;background:#141820}
  .in{flex:1;background:#0f1218;border:1px solid #23262d;border-radius:12px;padding:12px;color:var(--text)}
  .send{background:var(--accent);border:0;color:#08110f;font-weight:800;padding:0 14px;border-radius:12px}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(8px);background:#1b222c;border:1px solid #2a3140;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;color:#e8edf5;max-width:90vw}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Modal privacidad */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:92vw;max-width:420px;background:#141820;border:1px solid #23262d;border-radius:12px}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid #23262d;background:#10141b}
  .modal .content{padding:12px;display:grid;gap:12px}
  .row2{display:flex;justify-content:space-between;align-items:center}
  .switch{position:relative;width:46px;height:26px;background:#2a3140;border-radius:999px;border:1px solid #354052;cursor:pointer}
  .switch input{display:none}
  .switch .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;background:#cbd5e1;border-radius:50%;transition:.2s}
  .switch input:checked + .knob{left:24px;background:#3ddc97}
  .radio-row{display:flex;gap:8px;flex-wrap:wrap}
  .radio{background:#1a212c;border:1px solid #2a3140;border-radius:10px;padding:8px 10px}

  /* Add Contact modal & elements */
  .modal .seg4{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px}
  .field{display:grid;gap:6px;margin:8px 0}
  .field input{background:#0f1218;border:1px solid #23262d;border-radius:10px;padding:10px;color:var(--text)}
  .actions{display:flex;gap:8px;justify-content:flex-end}
  .qr{height:180px;background:repeating-linear-gradient(45deg,#202633 0 6px,#141820 6px 12px);border:1px solid #2a3140;border-radius:12px;display:grid;place-items:center;color:#8b97a7}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#232a36;border:1px solid #2a3140;font-size:12px;color:#c8d2de}
  .iconbtn.small{width:auto;padding:6px 10px}
</style>

<style>
  #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font:600 13px system-ui;opacity:0;pointer-events:none;transition:.2s;z-index:9999}
  #toast.show{opacity:1}
  .ig-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;background:rgba(15,23,42,.7);border:1px solid rgba(148,163,184,.25)}
  .ig-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:16px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.7);color:#e5e7eb;font:800 14px system-ui;cursor:pointer}
  .ig-btn.primary{background:#facc15;color:#111827;border:none}
  .ig-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ig-card{background:rgba(2,6,23,.6);border:1px solid rgba(148,163,184,.20);border-radius:18px;padding:14px}
  .ig-muted{color:#94a3b8;font:600 12px system-ui}
  .ig-title{font:900 16px system-ui;color:#e5e7eb}
  .ig-qr{display:none;margin-top:12px;text-align:center}
  .ig-qr img{width:220px;border-radius:18px;background:#fff;padding:10px}
  .ig-kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
  .ig-kpi .k{border-radius:16px;border:1px solid rgba(148,163,184,.18);padding:10px;background:rgba(15,23,42,.5)}
  .ig-kpi .k .n{font:900 18px system-ui}
  .ig-kpi .k .l{font:700 12px system-ui;color:#94a3b8}
  @media (max-width:420px){ .ig-kpi{grid-template-columns:1fr 1fr} }
</style>

</head>
<body>

<div id="toast"></div>
<div style="position:sticky;top:0;z-index:50;background:rgba(2,6,23,.75);backdrop-filter:blur(10px);border-bottom:1px solid rgba(148,163,184,.15)">
  <div style="max-width:520px;margin:0 auto;padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div class="ig-pill">
      <div style="font:900 13px system-ui;color:#facc15">IG</div>
      <div>
        <div class="ig-title">Bot <span id="botLabel">V1</span></div>
        <div class="ig-muted">Conectado: <span id="botConn">‚Äî</span> ¬∑ Bot: <span id="botEnabled">‚Äî</span></div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="btnConnect" class="ig-btn">Conectar</button>
      <button id="btnToggle" class="ig-btn primary">Ativar</button>
    </div>
  </div>
  <div class="ig-qr" id="qrWrap">
    <div class="ig-muted" style="margin-bottom:6px">Escaneie o QR no WhatsApp ‚Üí Dispositivos conectados</div>
    <img id="qrImg" alt="QR"/>
  </div>
</div>

<div style="max-width:520px;margin:0 auto;padding:12px">
  <div class="ig-card">
    <div class="ig-title">Acesso r√°pido</div>
    <div class="ig-muted" style="margin-top:4px">Atalhos para as telas cl√°ssicas (modo painel) + KPIs r√°pidos.</div>
    <div class="ig-grid ig-links" style="margin-top:10px">
      <a id="goLeads" class="ig-btn" href="#">üë§ Leads</a>
      <a id="goQuote" class="ig-btn" href="#">üí∞ Cotizar</a>
      <a id="goAgenda" class="ig-btn" href="#">üìÖ Agenda</a>
      <a id="goProgram" class="ig-btn" href="#">‚è∞ Programar</a>
      <a id="goDash" class="ig-btn" href="#">üìä Dashboard</a>
      <a id="goClassic" class="ig-btn" href="#">üõ†Ô∏è Panel cl√°sico</a>
    </div>

    <div class="ig-kpi" id="kpis" style="display:none">
      <div class="k"><div class="n" id="kSent">‚Äî</div><div class="l">Mensagens (total)</div></div>
      <div class="k"><div class="n" id="kOld">‚Äî</div><div class="l">&lt; Ano m√≠nimo</div></div>
      <div class="k"><div class="n" id="kNew">‚Äî</div><div class="l">‚â• Ano m√≠nimo</div></div>
    </div>
    <div class="ig-muted" style="margin-top:10px" id="kpiNote"></div>
  </div>
</div>

<div class="app">
  <div class="topbar">
    <div class="title">Pontis</div>
    <div class="spacer"></div>
    <button class="iconbtn" id="btnAdd" title="+ Agregar">Ôºã</button>
    <button class="iconbtn" id="btnPrivacy" title="Privacidad">‚ò∞</button>
  </div>

  <!-- LIST SCREEN -->
  <div id="listScreen" class="screen active">
    <div class="seg">
      <button id="tabNear" class="active">Cerca</button>
      <button id="tabAll">Chats</button>
      <button id="tabReq">Solicitudes</button>
    </div>

    <div id="nearList" class="list">
      <div class="hint" id="invisibleHint" style="display:none">Est√°s <b>invisible</b>: otros no pueden verte ni escribirte.</div>
      <div class="row" data-open="Ana (cerca)" data-avatar="A" data-near="1">
        <div class="avatar">A</div>
        <div class="meta">
          <div>
            <div class="name">Ana (cerca)</div>
            <div class="preview">A 2 m ‚Ä¢ disponible</div>
          </div>
          <div class="time">12:41</div>
        </div>
      </div>
      <div class="row" data-open="Camila (cerca)" data-avatar="C" data-near="1">
        <div class="avatar">C</div>
        <div class="meta">
          <div>
            <div class="name">Camila (cerca)</div>
            <div class="preview">A 4 m ‚Ä¢ auriculares</div>
          </div>
          <div class="time">12:40</div>
        </div>
      </div>
      <div class="row" data-open="Relay de Pedro" data-avatar="R" data-near="1">
        <div class="avatar">R</div>
        <div class="meta">
          <div>
            <div class="name">Relay de Pedro</div>
            <div class="preview">Disponible para subir mensajes</div>
          </div>
          <div class="time">12:40</div>
        </div>
      </div>
    </div>

    <div id="allList" class="list" style="display:none">
      <div class="row" data-open="Ana" data-avatar="A">
        <div class="avatar">A</div>
        <div class="meta">
          <div>
            <div class="name">Ana</div>
            <div class="preview">Nos vemos en el tren üöÜ</div>
          </div>
          <div class="time">12:41</div>
        </div>
      </div>
      <div class="row" data-open="Marcos" data-avatar="M">
        <div class="avatar">M</div>
        <div class="meta">
          <div>
            <div class="name">Marcos</div>
            <div class="preview">En ruta a casa</div>
          </div>
          <div class="time">12:32</div>
        </div>
      </div>
      <div class="row" data-open="Soporte Pontis" data-avatar="S">
        <div class="avatar">S</div>
        <div class="meta">
          <div>
            <div class="name">Soporte Pontis</div>
            <div class="preview">¬øTe ayudamos con el relay?</div>
          </div>
          <div class="time">11:10</div>
        </div>
      </div>
    </div>

    <div id="reqList" class="list" style="display:none">
      <div class="hint">No hay solicitudes por ahora.</div>
    </div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatScreen" class="screen">
    <div class="chathead">
      <button id="backBtn" class="back">‚üµ</button>
      <div class="avatar" id="chatAvatar">A</div>
      <div class="who">
        <div id="chatName" class="name">Ana</div>
        <div id="chatSub" class="preview">Modo: Mesh (sin Internet)</div>
      </div>
      <span class="modechip" id="modeChip">Mesh</span>
      <span class="no-recv" id="noRecvChip" style="display:none">No recibe</span>
    </div>
    <div id="chatBody" class="chatbody">
      <div class="bubble them">Hola! Est√°s en el vag√≥n 5?<span class="btime">12:40</span></div>
      <div class="bubble me">S√≠, sin datos ahora. Probemos Pontis.<span class="btime">12:41</span></div>
    </div>
    <div class="composer">
      <input id="msg" class="in" placeholder="Mensaje"/>
      <button id="send" class="send">Enviar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Modal de privacidad -->
<div class="backdrop" id="privacyModal">
  <div class="modal">
    <header>
      <div>Privacidad</div>
      <button class="iconbtn" id="closePrivacy">‚úï</button>
    </header>
    <div class="content">
      <div class="row2">
        <div>Visibilidad (aparecer como conectado)</div>
        <label class="switch"><input type="checkbox" id="visibleToggle"><span class="knob"></span></label>
      </div>
      <div>
        <div style="margin-bottom:6px">Recibir mensajes de:</div>
        <div class="radio-row">
          <label class="radio"><input type="radio" name="recv" value="everyone" checked> Todos</label>
          <label class="radio"><input type="radio" name="recv" value="contacts"> Solo contactos</label>
          <label class="radio"><input type="radio" name="recv" value="none"> Nadie</label>
        </div>
      </div>
      <div>
        <div style="margin-bottom:6px">Compartir mi informaci√≥n:</div>
        <div class="radio-row">
          <label class="radio"><input type="checkbox" id="shareName"> Nombre</label>
          <label class="radio"><input type="checkbox" id="shareAvatar"> Foto/avatar</label>
          <label class="radio"><input type="checkbox" id="shareDistance"> Distancia</label>
        </div>
      </div>
      <div class="row2" style="justify-content:end">
        <button class="iconbtn" id="savePrivacy">‚úî</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Agregar contacto -->
<div class="backdrop" id="addModal">
  <div class="modal">
    <header>
      <div>Agregar contacto</div>
      <button class="iconbtn" id="closeAdd">‚úï</button>
    </header>
    <div class="content">
      <div class="seg4">
        <button class="iconbtn small" data-addtab="qr">QR</button>
        <button class="iconbtn small" data-addtab="user">@usuario</button>
        <button class="iconbtn small" data-addtab="code">C√≥digo</button>
        <button class="iconbtn small" data-addtab="phone">Tel√©fono</button>
      </div>
      <div id="add_qr" class="addpane">
        <div class="field">
          <div class="qr" id="qrBox">Mi QR (Pontis ID)</div>
          <div><span class="pill" id="myPontisId">P-<span id="pidVal"></span></span> <button class="iconbtn small" id="copyId">Copiar</button></div>
        </div>
        <div class="actions"><button class="iconbtn small" id="simulateScan">Simular escaneo</button></div>
      </div>
      <div id="add_user" class="addpane" style="display:none">
        <div class="field"><label>Usuario</label><input id="inUser" placeholder="@ejemplo"/></div>
        <div class="actions"><button class="iconbtn small" id="reqUser">Enviar solicitud</button></div>
      </div>
      <div id="add_code" class="addpane" style="display:none">
        <div class="field"><label>C√≥digo amigo</label><input id="inCode" placeholder="ABCD-1234-XYZ"/></div>
        <div class="actions"><button class="iconbtn small" id="reqCode">Enviar solicitud</button></div>
      </div>
      <div id="add_phone" class="addpane" style="display:none">
        <div class="field"><label>Tel√©fono (opcional)</label><input id="inPhone" placeholder="+55 11 99999-9999"/></div>
        <div class="actions"><button class="iconbtn small" id="reqPhone">Enviar solicitud</button></div>
        <div class="hint">El n√∫mero se usa solo para verificaci√≥n/descubrimiento si ambos lo permiten.</div>
      </div>
    </div>
  </div>
</div>

<script>
  // State
  const privacy={ visible:false, receive:'everyone', share:{name:false, avatar:false, distance:false} };
  let mode='mesh'; // mesh | relay | direct

  // Elements
  const listScreen=document.getElementById('listScreen');
  const chatScreen=document.getElementById('chatScreen');
  const tabNear=document.getElementById('tabNear');
  const tabAll=document.getElementById('tabAll');
  const tabReq=document.getElementById('tabReq');
  const nearList=document.getElementById('nearList');
  const allList=document.getElementById('allList');
  const reqList=document.getElementById('reqList');
  const invisibleHint=document.getElementById('invisibleHint');

  const chatBody=document.getElementById('chatBody');
  const chatNameEl=document.getElementById('chatName');
  const chatAvatarEl=document.getElementById('chatAvatar');
  const chatSub=document.getElementById('chatSub');
  const modeChip=document.getElementById('modeChip');
  const noRecvChip=document.getElementById('noRecvChip');
  const backBtn=document.getElementById('backBtn');
  const msgInput=document.getElementById('msg');
  const sendBtn=document.getElementById('send');

  const toast=document.getElementById('toast');

  // Privacy modal
  const btnPrivacy=document.getElementById('btnPrivacy');
  const modal=document.getElementById('privacyModal');
  const closePrivacy=document.getElementById('closePrivacy');
  const savePrivacy=document.getElementById('savePrivacy');
  const visibleToggle=document.getElementById('visibleToggle');

  // Add Contact modal refs
  const btnAdd=document.getElementById('btnAdd');
  const addModal=document.getElementById('addModal');
  const closeAdd=document.getElementById('closeAdd');
  const addTabs=document.querySelectorAll('[data-addtab]');
  const panes={ qr:document.getElementById('add_qr'), user:document.getElementById('add_user'), code:document.getElementById('add_code'), phone:document.getElementById('add_phone') };
  const pidVal=document.getElementById('pidVal');
  const copyId=document.getElementById('copyId');
  const simulateScan=document.getElementById('simulateScan');
  const inUser=document.getElementById('inUser');
  const inCode=document.getElementById('inCode');
  const inPhone=document.getElementById('inPhone');
  const reqUser=document.getElementById('reqUser');
  const reqCode=document.getElementById('reqCode');
  const reqPhone=document.getElementById('reqPhone');

  function showToast(t){ toast.textContent=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2000); }

  function setMode(newMode){
    mode=newMode;
    if(mode==='mesh'){ chatSub.textContent='Modo: Mesh (sin Internet)'; modeChip.textContent='Mesh'; }
    if(mode==='relay'){ chatSub.textContent='Modo: Relay cercano (sube/baja por otro)'; modeChip.textContent='Relay'; }
    if(mode==='direct'){ chatSub.textContent='Modo: Internet directo'; modeChip.textContent='Direct'; }
  }
  setMode('mesh');

  // Toggle lists (3 pesta√±as)
  function setActiveTab(which){
    tabNear.classList.toggle('active', which==='near');
    tabAll.classList.toggle('active', which==='all');
    tabReq.classList.toggle('active', which==='req');
    nearList.style.display = which==='near' ? 'block' : 'none';
    allList.style.display  = which==='all'  ? 'block' : 'none';
    reqList.style.display  = which==='req'  ? 'block' : 'none';
  }
  tabNear.addEventListener('click',()=>setActiveTab('near'));
  tabAll.addEventListener('click',()=>setActiveTab('all'));
  tabReq.addEventListener('click',()=>setActiveTab('req'));

  // Open chat
  document.querySelectorAll('#nearList .row, #allList .row').forEach(el=>{
    el.addEventListener('click',()=>{
      const name=el.dataset.open||'Chat';
      const avatar=el.dataset.avatar||name.trim().charAt(0).toUpperCase();
      chatNameEl.textContent=name; chatAvatarEl.textContent=avatar;
      listScreen.classList.remove('active'); chatScreen.classList.add('active');
    });
  });
  backBtn.addEventListener('click',()=>{ chatScreen.classList.remove('active'); listScreen.classList.add('active'); });

  // Send
  function uuid(){return 'xxxxxxxx'.replace(/[x]/g,()=>Math.floor(Math.random()*16).toString(16))}
  function hhmm(){const d=new Date();return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}

  sendBtn.addEventListener('click',()=>{
    const text=(msgInput.value||'').trim(); if(!text) return;
    const id=uuid();
    const my=document.createElement('div'); my.className='bubble me'; my.innerHTML=`${text}<span class="btime">${hhmm()} ‚Ä¢ <code>${id}</code></span>`; chatBody.appendChild(my); chatBody.scrollTop=chatBody.scrollHeight; msgInput.value='';

    if(mode==='mesh'){
      showToast('Enviado a relays cercanos (mesh)');
      setTimeout(()=>showToast('Servidor: recibido (ACK)'),700);
      setTimeout(()=>showToast('Servidor: duplicado ignorado'),1200);
    }
    if(mode==='relay'){
      showToast('Subido v√≠a Relay cercano');
      setTimeout(()=>{
        if(privacy.receive==='none'){ showToast('Mensaje entrante bloqueado (privacidad)'); return; }
        const them=document.createElement('div'); them.className='bubble them'; them.innerHTML=`Copiado ‚úîÔ∏è (Relay) <span class="btime">${hhmm()}</span>`; chatBody.appendChild(them); chatBody.scrollTop=chatBody.scrollHeight;
      },900);
    }
    if(mode==='direct'){
      showToast('Enviado directo al servidor');
    }
  });

  // Privacy
  function applyPrivacy(){
    invisibleHint.style.display = privacy.visible ? 'none' : 'block';
    noRecvChip.style.display = (privacy.receive==='none') ? 'inline-block':'none';
  }

  btnPrivacy.addEventListener('click',()=>{
    modal.style.display='flex';
    visibleToggle.checked = privacy.visible;
    document.querySelectorAll('input[name="recv"]').forEach(r=>r.checked=(r.value===privacy.receive));
    document.getElementById('shareName').checked=privacy.share.name;
    document.getElementById('shareAvatar').checked=privacy.share.avatar;
    document.getElementById('shareDistance').checked=privacy.share.distance;
  });
  document.getElementById('closePrivacy').addEventListener('click',()=>modal.style.display='none');
  document.getElementById('savePrivacy').addEventListener('click',()=>{
    privacy.visible = visibleToggle.checked;
    const r=document.querySelector('input[name="recv"]:checked');
    privacy.receive = r? r.value : 'everyone';
    privacy.share.name=document.getElementById('shareName').checked;
    privacy.share.avatar=document.getElementById('shareAvatar').checked;
    privacy.share.distance=document.getElementById('shareDistance').checked;
    applyPrivacy();
    modal.style.display='none';
    showToast('Privacidad actualizada');
  });

  applyPrivacy();

  // ===== Add Contact modal logic =====
  function makePontisId(){return (Math.random().toString(36).slice(2,6)+'-'+Math.random().toString(36).slice(2,6)).toUpperCase()}
  if(pidVal){ pidVal.textContent = makePontisId(); }

  function showPane(key){ Object.values(panes).forEach(p=>p.style.display='none'); panes[key].style.display='block'; }
  addTabs.forEach(btn=>btn.addEventListener('click',()=>showPane(btn.dataset.addtab)));

  btnAdd?.addEventListener('click',()=>{ addModal.style.display='flex'; showPane('qr'); });
  document.getElementById('closeAdd')?.addEventListener('click',()=>{ addModal.style.display='none'; });

  copyId?.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText('P-'+(pidVal?.textContent||'')); showToast('Pontis ID copiado'); }catch{ showToast('No se pudo copiar'); } });

  function addRequest(name, avatar){
    const row=document.createElement('div'); row.className='row'; row.dataset.name=name; row.dataset.avatar=avatar;
    row.innerHTML=`<div class="avatar">${avatar}</div>
      <div class="meta">
        <div><div class="name">${name}</div><div class="preview">Solicitud pendiente</div></div>
        <div class="time"><button class="iconbtn small accept">‚úî</button> <button class="iconbtn small reject">‚úï</button></div>
      </div>`;
    if(reqList.firstElementChild && reqList.firstElementChild.classList.contains('hint')){ reqList.firstElementChild.remove(); }
    reqList.appendChild(row);
    setActiveTab('req');
    showToast('Solicitud enviada');
  }
  function addContactToAllList(name, avatar){
    const row=document.createElement('div'); row.className='row'; row.dataset.open=name; row.dataset.avatar=avatar;
    row.innerHTML=`<div class="avatar">${avatar}</div>
      <div class="meta">
        <div><div class="name">${name}</div><div class="preview">Nuevo contacto</div></div>
        <div class="time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      </div>`;
    allList.insertBefore(row, allList.firstChild);
  }
  function acceptRequest(row){
    const name=row.dataset.name||'Contacto'; const avatar=row.dataset.avatar||'C';
    addContactToAllList(name, avatar); row.remove(); showToast('Contacto agregado'); setActiveTab('all');
  }
  function rejectRequest(row){ row.remove(); if(!reqList.querySelector('.row')){ reqList.innerHTML='<div class="hint">No hay solicitudes por ahora.</div>'; } showToast('Solicitud rechazada'); }

  // Inputs de m√©todos
  document.getElementById('reqUser')?.addEventListener('click',()=>{ const u=(inUser.value||'').trim(); if(!u) return showToast('Ingresa un usuario'); const name=u.startsWith('@')?u.slice(1):u; addRequest('@'+name, (name[0]||'U').toUpperCase()); inUser.value=''; addModal.style.display='none'; });
  document.getElementById('reqCode')?.addEventListener('click',()=>{ const c=(inCode.value||'').trim(); if(!c) return showToast('Ingresa un c√≥digo'); addRequest('C√≥digo '+c, 'C'); inCode.value=''; addModal.style.display='none'; });
  document.getElementById('reqPhone')?.addEventListener('click',()=>{ const p=(inPhone.value||'').trim(); if(!p) return showToast('Ingresa un tel√©fono'); addRequest('Tel '+p, 'T'); inPhone.value=''; addModal.style.display='none'; });

  // Delegaci√≥n para aceptar/rechazar en ‚ÄúSolicitudes‚Äù
  document.addEventListener('click',(ev)=>{
    const row=ev.target.closest('.row');
    if(row && row.closest('#reqList')){
      if(ev.target.matches('.accept')) acceptRequest(row);
      if(ev.target.matches('.reject')) rejectRequest(row);
    }
  });

  // Register service worker (helps offline and PWA install UX)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    });
  }

  // iOS: Add to Home Screen is manual; with manifest + icons + web-app-capable, it installs cleanly.
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(()=>{}));
  }
  function qs(s){return document.querySelector(s);}
  async function apiGet(url){ const r=await fetch(url,{credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  async function apiPost(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body: JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  function toast(msg){ const t=qs('#toast'); if(!t) return alert(msg); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }

  let BOT_ID=null;
  async function refresh(){
    const me = await apiGet('/api/me');
    BOT_ID = me.defaultBotId;
    const st = await apiGet('/api/status?botId='+encodeURIComponent(BOT_ID));
    qs('#botLabel').textContent = (BOT_ID||'').toUpperCase();
    qs('#botConn').textContent = st.connected ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå';
    qs('#botEnabled').textContent = st.enabled ? 'ON üü¢' : 'OFF üî¥';
    qs('#btnConnect').textContent = st.connected ? 'Desconectar' : 'Conectar';
    qs('#btnToggle').textContent = st.enabled ? 'Pausar envios' : 'Ativar envios';
    qs('#qrWrap').style.display = (!st.connected && st.qrDataUrl) ? 'block':'none';
    if (!st.connected && st.qrDataUrl) qs('#qrImg').src = st.qrDataUrl;

    // KPIs
    const stats = await apiGet('/api/stats?botId='+encodeURIComponent(BOT_ID));
    qs('#kpis').style.display = 'grid';
    qs('#kSent').textContent = String(stats.totalMessagesSent||0);
    qs('#kOld').textContent = String(stats.carsBelowMinYear||0);
    qs('#kNew').textContent = String(stats.carsAtOrAboveMinYear||0);
    qs('#kpiNote').textContent = 'Ano m√≠nimo atual: '+stats.minYearFollowUp+' (altere em Regras)';
  }

  async function toggleConnect(){ try{ await apiPost('/api/toggle-connect',{botId:BOT_ID}); await refresh(); }catch(e){ toast('Falhou: '+e.message); } }
  async function toggleEnabled(){ try{ await apiPost('/api/toggle-enabled',{botId:BOT_ID}); await refresh(); }catch(e){ toast('Falhou: '+e.message); } }

  window.addEventListener('DOMContentLoaded', async ()=>{
    try{
      await refresh();
      qs('#btnConnect').addEventListener('click', e=>{e.preventDefault(); toggleConnect();});
      qs('#btnToggle').addEventListener('click', e=>{e.preventDefault(); toggleEnabled();});
      qs('#goClassic').href='/m';
      qs('#goAgenda').href='/m/agenda';
      qs('#goProgram').href='/m/program';
      qs('#goLeads').href='/m/leads';
      qs('#goQuote').href='/m/quote';
      qs('#goDash').href='/m/dashboard';
    }catch(e){ location.href='/login'; }
  });
</script>

</body>
</html>
